<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Data Bridge</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        h1 {
            color: #00ff00;
            text-align: center;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 10px;
        }
        #status {
            text-align: center;
            margin: 20px 0;
            font-size: 14px;
            color: #ffff00;
        }
        #output {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            padding: 20px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .update-time {
            text-align: center;
            color: #888;
            font-size: 11px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>📈 Market Data API Bridge</h1>
    <div id="status">Initializing...</div>
    <div id="output">Loading market data...</div>
    <div class="update-time" id="updateTime"></div>

    <script>
        // API Configuration
        const API_KEYS = {
            alphavantage: 'OYNGCKHH1IWF3J4G',
            twelvedata: '744f65b6561047d0bbdc2ecb601445ca',
            finnhub: 'd35novhr01qhqkb37tpgd35novhr01qhqkb37tq0',
            polygon: '7_nYaWRYfGXSfa5HKrP_628othiF_DNZ'
        };
        
        // Stocks to monitor
        const WATCHLIST = ['SPY', 'QQQ', 'IWM', 'DIA', 'NVDA', 'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NFLX'];
        
        let callCount = 0;
        const MAX_CALLS_PER_MINUTE = 5; // Conservative limit
        
        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        async function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        async function fetchWithRetry(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await sleep(1000 * (i + 1)); // Exponential backoff
                }
            }
        }
        
        async function getTwelveDataQuote(ticker) {
            try {
                const url = `https://api.twelvedata.com/quote?symbol=${ticker}&apikey=${API_KEYS.twelvedata}`;
                const data = await fetchWithRetry(url);
                callCount++;
                
                if (data.status === 'error') {
                    console.error(`Twelve Data error for ${ticker}:`, data.message);
                    return null;
                }
                
                return {
                    source: 'TwelveData',
                    price: parseFloat(data.close || 0),
                    open: parseFloat(data.open || 0),
                    high: parseFloat(data.high || 0),
                    low: parseFloat(data.low || 0),
                    volume: parseInt(data.volume || 0),
                    change: parseFloat(data.change || 0),
                    percent_change: parseFloat(data.percent_change || 0),
                    timestamp: data.datetime || new Date().toISOString()
                };
            } catch (error) {
                console.error(`Error fetching ${ticker} from Twelve Data:`, error);
                return null;
            }
        }
        
        async function getFinnhubQuote(ticker) {
            try {
                const url = `https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${API_KEYS.finnhub}`;
                const data = await fetchWithRetry(url);
                callCount++;
                
                return {
                    source: 'Finnhub',
                    price: parseFloat(data.c || 0),
                    open: parseFloat(data.o || 0),
                    high: parseFloat(data.h || 0),
                    low: parseFloat(data.l || 0),
                    prev_close: parseFloat(data.pc || 0),
                    change: parseFloat(data.d || 0),
                    percent_change: parseFloat(data.dp || 0),
                    timestamp: data.t ? new Date(data.t * 1000).toISOString() : new Date().toISOString()
                };
            } catch (error) {
                console.error(`Error fetching ${ticker} from Finnhub:`, error);
                return null;
            }
        }
        
        async function getPolygonQuote(ticker) {
            try {
                const url = `https://api.polygon.io/v2/aggs/ticker/${ticker}/prev?adjusted=true&apiKey=${API_KEYS.polygon}`;
                const data = await fetchWithRetry(url);
                callCount++;
                
                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    return {
                        source: 'Polygon',
                        price: parseFloat(result.c || 0),
                        open: parseFloat(result.o || 0),
                        high: parseFloat(result.h || 0),
                        low: parseFloat(result.l || 0),
                        volume: parseInt(result.v || 0),
                        vwap: parseFloat(result.vw || 0),
                        timestamp: new Date(result.t).toISOString()
                    };
                }
                return null;
            } catch (error) {
                console.error(`Error fetching ${ticker} from Polygon:`, error);
                return null;
            }
        }
        
        async function getMarketData() {
            const marketData = {
                generated_at: new Date().toISOString(),
                market_status: 'OPEN', // Would need to check actual market hours
                stocks: {}
            };
            
            updateStatus(`Fetching data for ${WATCHLIST.length} stocks...`);
            
            for (let i = 0; i < WATCHLIST.length; i++) {
                const ticker = WATCHLIST[i];
                updateStatus(`Fetching ${ticker} (${i + 1}/${WATCHLIST.length})...`);
                
                // Try Twelve Data first (most complete)
                let stockData = await getTwelveDataQuote(ticker);
                
                // If Twelve Data fails, try Finnhub
                if (!stockData) {
                    await sleep(200); // Small delay between API calls
                    stockData = await getFinnhubQuote(ticker);
                }
                
                // Store the data
                if (stockData) {
                    marketData.stocks[ticker] = stockData;
                    
                    // Calculate support/resistance levels (simple method)
                    if (stockData.high && stockData.low) {
                        const range = stockData.high - stockData.low;
                        marketData.stocks[ticker].support = (stockData.low - range * 0.382).toFixed(2);
                        marketData.stocks[ticker].resistance = (stockData.high + range * 0.382).toFixed(2);
                    }
                }
                
                // Rate limiting
                if (callCount >= MAX_CALLS_PER_MINUTE) {
                    updateStatus('Rate limit - waiting 60 seconds...');
                    await sleep(60000);
                    callCount = 0;
                }
                
                // Small delay between requests
                await sleep(300);
            }
            
            updateStatus(`Completed! ${Object.keys(marketData.stocks).length} stocks loaded`);
            return marketData;
        }
        
        async function updateDisplay() {
            try {
                const data = await getMarketData();
                
                // Display formatted data
                document.getElementById('output').textContent = JSON.stringify(data, null, 2);
                
                // Update timestamp
                const now = new Date().toLocaleString();
                document.getElementById('updateTime').textContent = `Last updated: ${now}`;
                
                updateStatus('✅ Data ready - Updating every 5 minutes');
            } catch (error) {
                updateStatus(`❌ Error: ${error.message}`);
                console.error('Error updating display:', error);
            }
        }
        
        // Initialize
        updateDisplay();
        
        // Auto-update every 5 minutes
        setInterval(updateDisplay, 5 * 60 * 1000);
        
        // Manual refresh on click
        document.getElementById('output').addEventListener('click', () => {
            updateStatus('Manual refresh triggered...');
            updateDisplay();
        });
    </script>
</body>
</html>
